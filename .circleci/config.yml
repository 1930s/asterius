version: 2

jobs:
  asterius:
    docker:
      - image: terrorjack/meikyu:ghc-head
    environment:
      MAKEFLAGS: -j4
      XZ_OPT: -9
    steps:
      - checkout
      - restore_cache:
          key: stack-work-gen7-
      - run: |
          apk add --no-cache --no-progress \
              autoconf \
              cmake \
              coreutils \
              findutils \
              g++ \
              make \
              nodejs-current \
              sed \
              xz
          stack --no-terminal test --haddock asterius:fact-dump
          stack --no-terminal test --haddock asterius:ahc-boot
          if [ $CIRCLE_PROJECT_USERNAME == "tweag" ] && [ $CIRCLE_BRANCH == "master" ]
          then
            export PREV_DIR=`pwd`
            cp -r `stack path --local-doc-root` /tmp/
            cd /tmp/doc
            touch .nojekyll
            git init
            git config user.email "cheng.shao@tweag.io"
            git config user.name "Shao Cheng"
            git checkout -b gh-pages
            git add --all
            git commit -q --message="Haddock documentation of tweag/asterius@$CIRCLE_SHA1"
            git push https://TerrorJack:$GH_TOKEN@github.com/tweag/asterius.git gh-pages --force
            cd $PREV_DIR
            unset PREV_DIR
          fi
          cd /tmp
          tar -cJf /tmp/asterius_boot.tar.xz asterius/.boot
          rm -rf /root/.stack/programs
      - store_artifacts:
          path: /tmp/asterius_boot.tar.xz
      - save_cache:
          key: stack-work-gen7-{{ .BuildNum }}
          paths:
            - /root/.stack
            - .stack-work
            - asterius/.stack-work
            - cereal-utils/.stack-work
            - ghc-toolkit/.stack-work
            - binaryen/.stack-work
            - wasm-toolkit/.stack-work

  binaryen:
    docker:
      - image: terrorjack/vanilla:haskell
    environment:
      - MAKEFLAGS: -j4
    steps:
      - checkout
      - restore_cache:
          key: binaryen-stack-work
      - run: stack --no-terminal --resolver ghc-8.4.1 --nix-packages "cmake gcc gnumake" test --haddock --flag hashable:integer-gmp binaryen:binaryen-test
      - save_cache:
          key: binaryen-stack-work-{{ .BuildNum }}
          paths:
            - /root/.stack
            - .stack-work
            - binaryen/.stack-work

  ghc-toolkit:
    docker:
      - image: terrorjack/vanilla:haskell
    steps:
      - checkout
      - restore_cache:
          key: ghc-toolkit-stack-work
      - run: stack --no-terminal --resolver ghc-8.4.1 build --haddock --flag hashable:integer-gmp --flag ghc-toolkit:-build-orphans ghc-toolkit
      - save_cache:
          key: ghc-toolkit-stack-work-{{ .BuildNum }}
          paths:
            - /root/.stack
            - .stack-work
            - ghc-toolkit/.stack-work

workflows:
  version: 2
  build:
    jobs:
      - asterius
      - binaryen
      - ghc-toolkit
